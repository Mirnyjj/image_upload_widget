(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[996],{161:(e,t,n)=>{"use strict";n.d(t,{default:()=>g});var a=n(5155),l=n(2115);let o=async(e,t,n)=>{try{let a=await fetch(t,{headers:{"Content-Type":"application/json","X-Authorization":"Bearer ".concat(e)},signal:n});if(!a.ok)throw Error("HTTP error! status: ".concat(a.status));return await a.json()}catch(e){if(e instanceof DOMException&&"AbortError"===e.name)throw console.log("Запрос отменен:",e.message),Error("Запрос был отменен");if(e instanceof Error)throw e;throw Error("Неизвестная ошибка")}},s=async(e,t,n,a,l)=>{let s={root:{},devices:[],objects:[]};try{let i="tenant"===a?"tenant":"".concat(a,"/").concat(n),r="".concat(t,"/api/").concat(i,"/assets?limit=100"),c="".concat(t,"/api/").concat(i,"/devices?limit=1000"),d=await o(e,r,l),u=await o(e,c,l);if((null==d?void 0:d.data)&&(null==d?void 0:d.data.length)!==0){let e=d.data.find(e=>"root"===e.type);Object.assign(s,{root:e});let t=d.data.filter(e=>"area"!==e.type&&"root"!==e.type).map(e=>({name:e.name,id:e.id.id,typeObj:e.type?e.type:"",type:e.id.entityType}));Object.assign(s,{objects:t})}if((null==u?void 0:u.data)&&(null==u?void 0:u.data.length)!==0){let e=u.data.filter(e=>"Alarm"!==e.type).map(e=>({name:e.name,id:e.id.id,typeObj:e.type?e.type:"",type:e.id.entityType}));Object.assign(s,{devices:e})}return s}catch(e){return e instanceof Error&&console.log(e.message),s}};function i(e){let{API_BASE_URL:t,token:n,ID_USER:i,isObject:r,isDevice:c,authority:d,setIndex:u}=e,[h,p]=(0,l.useState)(null),[g,m]=(0,l.useState)(null),[f,y]=(0,l.useState)(null),j=async(e,a)=>{let l=f?"DEVICE":"ASSET",s="".concat(t,"/api/plugins/telemetry/").concat(l,"/").concat(e,"/keys/attributes"),i=await o(n,s,a.signal);if(0!==i.length){var r;let e=null==(r=i.filter(e=>e.includes("img")))?void 0:r.sort();0!==e.length&&u(+e[e.length-1].split("_")[1])}};return((0,l.useEffect)(()=>{let e=new AbortController;return g?(r(g),o(n,"".concat(t,"/api/asset/").concat(g)).then(e=>console.log(e)),j(g,e)):f&&(c(f),j(f,e)),()=>{e.abort()}},[g,f]),(0,l.useEffect)(()=>{let e=new AbortController;return n&&s(n,t,i,d,e.signal).then(e=>{e&&e.objects&&p(e)}).catch(e=>{console.log(e.message)}),()=>{e.abort()}},[n]),h)?(0,a.jsxs)("div",{children:[0!==h.objects.length&&(0,a.jsxs)("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column"},children:[(0,a.jsx)("h2",{children:"Выберите объект из списка"}),(0,a.jsx)("select",{name:"objects",id:"objects",onChange:e=>{m(e.target.value),y(null)},defaultValue:"Выберите из списка",children:h.objects.map(e=>(0,a.jsx)("option",{value:e.id,children:e.name},e.id))})]}),0!==h.devices.length&&(0,a.jsxs)("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column"},children:[(0,a.jsx)("h2",{children:"Выберите устройство из списка"}),(0,a.jsx)("select",{name:"devices",id:"devices",onChange:e=>{y(e.target.value),m(null)},defaultValue:"Выберите из списка",children:h.devices.map(e=>(0,a.jsx)("option",{value:e.id,children:e.name},e.id))})]})]}):(0,a.jsx)("div",{children:"Loading..."})}var r=n(6710);let c={display:"flex",flexDirection:"column",justifyContent:"center",gap:"10px",alignItems:"center",padding:"20px",borderColor:"#eeeeee",borderStyle:"dashed",backgroundColor:"#fafafa",color:"#bdbdbd",transition:"border .3s ease-in-out"},d={borderColor:"#2196f3"},u={borderColor:"#00e676"},h={borderColor:"#ff1744"},p=function(e){let{setBase64Img:t}=e,[n,o]=(0,l.useState)([]),s=(0,l.useCallback)(e=>{o(e.map(e=>Object.assign(e,{preview:URL.createObjectURL(e)})));let n=e.find(e=>e),a=new FileReader;n&&a.readAsDataURL(n),a.onload=()=>{(null==a?void 0:a.result)&&t(a.result)}},[t]),{getRootProps:i,getInputProps:p,isDragActive:g,isDragAccept:m,isDragReject:f}=(0,r.VB)({onDrop:s,accept:{"image/*":[".png",".jpg",".jpeg"]}}),y=(0,l.useMemo)(()=>({...c,...g?d:{},...m?u:{},...f?h:{}}),[g,f,m]),j=n.map(e=>(0,a.jsx)("img",{src:e.preview,alt:e.name,className:"imgStyle"},e.name)),b=async e=>{try{let t=await fetch(e),n=await t.blob();return new Promise((e,t)=>{let a=new FileReader;a.onloadend=()=>e(a.result),a.onerror=t,a.readAsDataURL(n)})}catch(e){return console.error("Error converting image URL to Base64:",e),null}};return(0,l.useEffect)(()=>()=>{n.forEach(e=>URL.revokeObjectURL(e.preview))},[n]),(0,l.useEffect)(()=>{var e,t;(null==(e=n[0])?void 0:e.preview.length)!==0&&b(null==(t=n[0])?void 0:t.preview)},[n]),(0,a.jsxs)("div",{...i({style:y}),className:"imgStyle",children:[(0,a.jsx)("input",{...p(),name:"img-data"}),(0,a.jsx)("div",{style:{textAlign:"center"},children:"Перетащите сюда вашe изображениe, или кликните по выделенной области, для выбора из файловой системы."}),(0,a.jsx)("aside",{className:"contentCenter",children:j})]})};function g(e){let{id:t,token:n,authority:s}=e,[r,c]=(0,l.useState)(null),[d,u]=(0,l.useState)(""),[h,g]=(0,l.useState)(null),[m,f]=(0,l.useState)(null),[y,j]=(0,l.useState)(null),[b,v]=(0,l.useState)(!0),[x,S]=(0,l.useState)(),[E,w]=(0,l.useState)(""),C="http://localhost:8080";(0,l.useEffect)(()=>{m||h?(v(!1),u("")):(v(!0),u("Выберите устройство, либо объект из списка")),m&&o(n,"".concat(C,"/api/device/").concat(m,"/credentials")).then(e=>{0!==Object.keys(e).length&&j(e.credentialsId)}).catch(e=>{u("Ошибка получения токена устройства: ".concat(e.message))})},[m,h]);let O=async(e,t,n,a)=>{y&&fetch("".concat(t,"/api/v1/").concat(y,"/attributes"),{method:"POST",headers:{"Content-Type":"application/json","X-Authorization":"Bearer ".concat(n)},body:JSON.stringify({["img_".concat(x?x+1:0)]:a})}).then(e=>{200===e.status&&(w("Изображение успешно загружено!"),c(null),setTimeout(()=>w(""),2e3))}).catch(e=>u(e.message)),console.log(e),e&&fetch("".concat(t,"/api/plugins/telemetry/ASSET/").concat(e,"/SHARED_SCOPE"),{method:"POST",headers:{"Content-Type":"application/json","X-Authorization":"Bearer ".concat(n)},body:JSON.stringify({["img_".concat(x?x+1:0)]:a})}).then(e=>console.log(e)).catch(e=>u(e.message))};return 0!==E.length?(0,a.jsx)("h2",{children:E}):(0,a.jsxs)("section",{className:"section",children:[(0,a.jsx)(i,{ID_USER:t,token:n,API_BASE_URL:C,isObject:g,isDevice:f,authority:s,setIndex:S}),(0,a.jsx)(p,{setBase64Img:c}),r&&(0,a.jsx)("button",{onClick:()=>O(h,C,n,r),type:"submit",disabled:b,children:"Загрузить на сервер"}),d&&(0,a.jsx)("p",{style:{color:"red"},children:d})]})}},6434:(e,t,n)=>{Promise.resolve().then(n.bind(n,161))}},e=>{e.O(0,[710,441,964,358],()=>e(e.s=6434)),_N_E=e.O()}]);