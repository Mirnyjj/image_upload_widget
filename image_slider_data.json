{
  "alias": "image_slider_ver_2",
  "name": "Image Slider data",
  "descriptor": {
    "type": "latest",
    "sizeX": 7.5,
    "sizeY": 6.5,
    "resources": [],
    "templateHtml": "<div class='SliderCard'>\r\n    <img id=\"sliderImageId\" src=\"\">\r\n    \r\n    <div class=\"slider__control--left\" ng-click=\"prevImage()\">\r\n        <div class=\"slider__control-line\"></div>\r\n        <div class=\"slider__control-line\"></div>\r\n    </div>\r\n    <div class=\"slider__control--right\" ng-click=\"nextImage()\">\r\n        <div class=\"slider__control-line\"></div>\r\n        <div class=\"slider__control-line\"></div>\r\n    </div>\r\n    \r\n</div>",
    "templateCss": ".SliderCard {\n    width: 100%;\n    height: 100%;\n    justify-content: center;\n    align-items: center;\n    display: flex;\n    text-align: center;\n}\n\n.SliderCard img {\n    display: block;\n    margin-left: auto;\n    margin-right: auto;\n    max-width: 100%;\n    max-height: 100%;\n    outline: none;\n}\n\n.slider__control--left, .slider__control--right {\n  z-index: 100;\n  position: absolute;\n  top: 50%;\n  width: 40px;\n  height: 40px;\n  border-radius: 100%;\n  background: #305680;\n  -webkit-transition: background-color 0.3s;\n  transition: background-color 0.3s;\n  cursor: pointer;\n  transform: translate(0%,-50%);\n  outline: none;\n  opacity: 0.9;\n}\n\n.slider__control--left {\n  left: 0%;\n  -ms-transform: translate(-0%,-50%);\n}\n\n.slider__control--right {\n  right: 0%;\n  -ms-transform: translate(0%,-50%);\n}\n\n.slider__control--left:hover, .slider__control--right:hover  {\n  background-color: #ff3d01;\n}\n\n.slider__control-line {\n  position: absolute;\n  left: 13px;\n  top: 50%;\n  width: 3px;\n  height: 14px;\n  -webkit-transform-origin: 50% 0;\n          transform-origin: 50% 0;\n  -webkit-transform: rotate(-45deg);\n          transform: rotate(-45deg);\n}\n\n.slider__control-line:nth-child(2) {\n  -webkit-transform: translateY(1px) rotate(-135deg);\n          transform: translateY(1px) rotate(-135deg);\n}\n\n.slider__control--right .slider__control-line {\n  left: 27px;\n  -webkit-transform-origin: 1px 0;\n          transform-origin: 1px 0;\n  -webkit-transform: rotate(45deg);\n          transform: rotate(45deg);\n}\n\n.slider__control--right .slider__control-line:nth-child(2) {\n  -webkit-transform: translateY(1px) rotate(135deg);\n          transform: translateY(1px) rotate(135deg);\n}\n\n.slider__control-line:after {\n  content: \"\";\n  position: absolute;\n  left: 0;\n  top: 0;\n  width: 100%;\n  height: 100%;\n  background-color: #e2e2e2;\n  -webkit-transition: background-color 0.3s;\n  transition: background-color 0.3s;\n}\n\n.slider__control--left:hover .slider__control-line:after {\n  background-color: #fff;\n}\n\n.slider__control--left.a--rotation .slider__control-line:after {\n  -webkit-animation: arrowLineRotation 0.49s;\n          animation: arrowLineRotation 0.49s;\n}\n\n.slider__control--left.a--rotation .slider__control-line:nth-child(1):after {\n  -webkit-animation: arrowLineRotationRev 0.49s;\n          animation: arrowLineRotationRev 0.49s;\n}\n\n@-webkit-keyframes arrowLineRotation {\n  to {\n    -webkit-transform: rotate(180deg);\n            transform: rotate(180deg);\n  }\n}\n\n@keyframes arrowLineRotation {\n  to {\n    -webkit-transform: rotate(180deg);\n            transform: rotate(180deg);\n  }\n}\n@-webkit-keyframes arrowLineRotationRev {\n  to {\n    -webkit-transform: rotate(-180deg);\n            transform: rotate(-180deg);\n  }\n}\n@keyframes arrowLineRotationRev {\n  to {\n    -webkit-transform: rotate(-180deg);\n            transform: rotate(-180deg);\n  }\n}",
    "controllerScript": "let $scope;\nlet attributeService;\nlet counter = 0;\nlet currentIndex = 0;\nlet entitysArr = [];\n\nself.onInit = function() {\n    $scope = self.ctx.$scope;\n    entitysArr = self.ctx.datasources || [];\n    attributeService = $scope.$injector.get('attributeService');\n    \n\n    initUI();\n    \n\n    loadData();\n};\n\nasync function loadData() {\n    try {\n        const attributes = await loadAttributes();\n        if (attributes && attributes.length) {\n            processAttributes(attributes);\n            updateUI();\n        } else {\n            console.warn('No attributes loaded');\n            self.ctx.settings.imageURLs = [];\n            updateUI();\n        }\n    } catch (error) {\n        console.error('Error in loadData:', error);\n        self.ctx.settings.imageURLs = [];\n        updateUI();\n    }\n}\n\nasync function loadAttributes() {\n    if (!entitysArr.length) return [];\n\n    try {\n\n        const attributesPromises = entitysArr.map(entity => \n            attributeService.getEntityAttributesValues(\n                entity.entityType || 'DEVICE', \n                entity.entityId, \n                'CLIENT_SCOPE'\n            )\n        );\n\n        const results = await Promise.all(attributesPromises);\n        return results.flat().filter(attr => attr);\n    } catch (error) {\n        console.error('Error loading attributes:', error);\n        return [];\n    }\n}\n\nfunction processAttributes(attributes) {\n\n    const imageAttributes = attributes\n        .filter(attr => attr.key && attr.key.startsWith('img_'))\n        .sort((a, b) => {\n            const numA = parseInt(a.key.split('_')[1]);\n            const numB = parseInt(b.key.split('_')[1]);\n            return numA - numB;\n        });\n\n \n    self.ctx.settings.imageURLs = imageAttributes\n        .map(attr => attr.value)\n        .filter(url => url && url.startsWith('data:image'));\n}\n\nfunction initUI() {\n    $scope.prevImage = () => {\n        if (!self.ctx.settings.imageURLs?.length) return;\n        \n        currentIndex = (currentIndex > 0) ? currentIndex - 1 : self.ctx.settings.imageURLs.length - 1;\n        updateImage();\n    };\n    \n    $scope.nextImage = () => {\n        if (!self.ctx.settings.imageURLs?.length) return;\n        \n        currentIndex = (currentIndex < self.ctx.settings.imageURLs.length - 1) ? currentIndex + 1 : 0;\n        updateImage();\n    };\n}\n\nfunction updateUI() {\n    if (!self.ctx.settings.imageURLs?.length) {\n        console.log('No images to display');\n\n        const imgElement = document.getElementById(\"sliderImageId\");\n        if (imgElement) imgElement.src = '';\n        return;\n    }\n    \n\n    currentIndex = Math.max(0, Math.min(currentIndex, self.ctx.settings.imageURLs.length - 1));\n    updateImage();\n}\n\nfunction updateImage() {\n    const imgElement = document.getElementById(\"sliderImageId\");\n    if (!imgElement) {\n        console.error('Image element not found');\n        return;\n    }\n    \n    imgElement.src = self.ctx.settings.imageURLs[currentIndex];\n}\n\nself.onDataUpdated = function() {\n    if (!self.ctx.isEdit) return;\n    \n    counter++;\n    if (counter > 1) return;\n    \n    const datasource = self.ctx.datasources?.[0];\n    if (!datasource?.entityId) return;\n\n    const attributesToSave = self.ctx.settings.imageURLs.map((url, index) => ({\n        key: `img_${index}`,\n        value: url || ''\n    }));\n    \n\n    attributeService.saveEntityAttributes(\n        datasource.entityType || 'DEVICE',\n        datasource.entityId,\n        'SERVER_SCOPE',\n        attributesToSave\n    ).then(\n        () => console.log('Attributes saved successfully'),\n        error => console.error('Failed to save attributes:', error)\n    );\n};\n\nself.typeParameters = function() {\n    return {\n        maxDatasources: 1,\n        dataKeysOptional: true\n    };\n};\n\nself.onDestroy = function() {\n    self.ctx.settings.imageURLs = [];\n};",
    "settingsSchema": "{\n    \"schema\": {\n        \"type\": \"object\",\n        \"title\": \"Slider Configuration\",\n        \"properties\": {\n            \"imageURLs\": {\n                \"title\": \"Image URLs\",\n                \"type\": \"array\",\n                \"items\": {\n                    \"title\": \"Image URL\",\n                    \"type\": \"string\",\n                    \"default\": \"\"\n                }\n            }\n        },\n        \"required\": []\n    },\n    \"form\": [\n        {\n            \"key\": \"imageURLs\",\n            \"items\": [\n                {\n                    \"key\": \"imageURLs[]\",\n                    \"type\": \"image\"\n                }\n            ]\n        }\n    ]\n}",
    "dataKeySettingsSchema": "{}\n",
    "defaultConfig": "{\"datasources\":[{\"type\":\"function\",\"name\":\"function\",\"dataKeys\":[{\"name\":\"f(x)\",\"type\":\"function\",\"label\":\"img_0\",\"color\":\"#2196f3\",\"settings\":{},\"_hash\":0.46906357604677873,\"funcBody\":\"return prevValue + 1;\"}]}],\"timewindow\":{\"realtime\":{\"timewindowMs\":60000}},\"showTitle\":false,\"backgroundColor\":\"rgb(255, 255, 255)\",\"color\":\"rgba(0, 0, 0, 0.87)\",\"padding\":\"8px\",\"settings\":{\"imageURLs\":[\"data:image/svg+xml;base64,PHN2ZyBpZD0ic3ZnMiIgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMTAwIiB3aWR0aD0iMTAwIiB2ZXJzaW9uPSIxLjEiIHhtbG5zOmNjPSJodHRwOi8vY3JlYXRpdmVjb21tb25zLm9yZy9ucyMiIHhtbG5zOmRjPSJodHRwOi8vcHVybC5vcmcvZGMvZWxlbWVudHMvMS4xLyIgdmlld0JveD0iMCAwIDEwMCAxMDAiPgogPGcgaWQ9ImxheWVyMSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMCAtOTUyLjM2KSI+CiAgPHJlY3QgaWQ9InJlY3Q0Njg0IiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBoZWlnaHQ9Ijk5LjAxIiB3aWR0aD0iOTkuMDEiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiB5PSI5NTIuODYiIHg9Ii40OTUwNSIgc3Ryb2tlLXdpZHRoPSIuOTkwMTAiIGZpbGw9IiNlZWUiLz4KICA8dGV4dCBpZD0idGV4dDQ2ODYiIHN0eWxlPSJ3b3JkLXNwYWNpbmc6MHB4O2xldHRlci1zcGFjaW5nOjBweDt0ZXh0LWFuY2hvcjptaWRkbGU7dGV4dC1hbGlnbjpjZW50ZXIiIGZvbnQtd2VpZ2h0PSJib2xkIiB4bWw6c3BhY2U9InByZXNlcnZlIiBmb250LXNpemU9IjEwcHgiIGxpbmUtaGVpZ2h0PSIxMjUlIiB5PSI5NzAuNzI4MDkiIHg9IjQ5LjM5NjQ3NyIgZm9udC1mYW1pbHk9IlJvYm90byIgZmlsbD0iIzY2NjY2NiI+PHRzcGFuIGlkPSJ0c3BhbjQ2OTAiIHg9IjUwLjY0NjQ3NyIgeT0iOTcwLjcyODA5Ij5JbWFnZSBiYWNrZ3JvdW5kIDwvdHNwYW4+PHRzcGFuIGlkPSJ0c3BhbjQ2OTIiIHg9IjQ5LjM5NjQ3NyIgeT0iOTgzLjIyODA5Ij5pcyBub3QgY29uZmlndXJlZDwvdHNwYW4+PC90ZXh0PgogIDxyZWN0IGlkPSJyZWN0NDY5NCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgaGVpZ2h0PSIxOS4zNiIgd2lkdGg9IjY5LjM2IiBzdHJva2U9IiMwMDAiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgeT0iOTkyLjY4IiB4PSIxNS4zMiIgc3Ryb2tlLXdpZHRoPSIuNjM5ODYiIGZpbGw9Im5vbmUiLz4KIDwvZz4KPC9zdmc+Cg==\"]},\"title\":\"Image Slider data\",\"dropShadow\":true,\"enableFullscreen\":true,\"widgetStyle\":{},\"titleStyle\":{\"fontSize\":\"16px\",\"fontWeight\":400},\"useDashboardTimewindow\":true,\"showLegend\":false,\"actions\":{}}"
  }
}